#!/bin/bash
echo "" > cisd
echo "IP:        `hostname -i`" &>> cisd
echo "HOSTNAME:  `hostname -f`" &>> cisd
echo "Date:      `date` "       &>> cisd

echo "" >> cisd
echo "" >> cisd

echo "install cramfs /bin/true" >> /etc/modprobe.d/CIS.conf
echo "install freevxfs /bin/true" >> /etc/modprobe.d/CIS.conf
echo "install hfs /bin/true" >> /etc/modprobe.d/CIS.conf
echo "install jffs2  /bin/true" >> /etc/modprobe.d/CIS.conf
echo "install hfsplus /bin/true" >> /etc/modprobe.d/CIS.conf
echo "install squashfs /bin/true" >> /etc/modprobe.d/CIS.conf
echo "install udf  /bin/true" >> /etc/modprobe.d/CIS.conf
echo "install vfat /bin/true" >> /etc/modprobe.d/CIS.conf

echo "contents of /etc/modprobe.d/CIS.conf file for controll id 1.1.1.1-1.1.1.8" >> cisd
cat /etc/modprobe.d/CIS.conf >> cisd

echo "" >> cisd
echo "" >> cisd

echo "controll id 1.1.17  " >> cisd
mount -o remount,noexec /dev/shm
echo "check noexec option " >> cisd
mount | grep /dev/shm &>> cisd

echo "" >> cisd
echo "" >> cisd

echo "1.1.22 Disable Automounting (Scored)" >> cisd
systemctl disable autofs
echo "systemctl is-enabled autofs disabled" >> cisd
systemctl is-enabled autofs disabled &>> cisd


echo "" >> cisd
echo "" >> cisd

echo "1.4.1 Ensure permissions on bootloader config are configured (Scored)" &>> cisd
chown root:root /boot/grub2/grub.cfg
chmod og-rwx /boot/grub2/grub.cfg
echo "verify Uid and Gid are both 0/root and Access does not grant permissions to group or other" &>> cisd
stat /boot/grub2/grub.cfg &>> cisd


echo "" >> cisd
echo "" >> cisd

echo "3.2.4 Ensure suspicious packets are logged (Scored)" &>> cisd
echo "net.ipv4.conf.all.log_martians = 1 " >> /etc/sysctl.conf 
echo "net.ipv4.conf.default.log_martians = 1" >> /etc/sysctl.conf 
sysctl -w net.ipv4.conf.all.log_martians=1 
sysctl -w net.ipv4.conf.default.log_martians=1
sysctl -w net.ipv4.route.flush=1

echo "check consecutive output must be 1" >> cisd
sysctl net.ipv4.conf.all.log_martians &>> cisd
sysctl net.ipv4.conf.default.log_martians &>> cisd

echo "" >> cisd
echo "" >> cisd

echo "3.2.7 Ensure Reverse Path Filtering is enabled (Scored)" &>> cisd
echo "net.ipv4.conf.all.rp_filter = 1  " >> /etc/sysctl.conf 
echo "net.ipv4.conf.default.rp_filter = 1" >> /etc/sysctl.conf 
sysctl -w net.ipv4.conf.all.rp_filter=1
sysctl -w net.ipv4.conf.default.rp_filter=1
sysctl -w net.ipv4.route.flush=1

echo "check consecutive output must be 1" >> cisd
sysctl net.ipv4.conf.all.rp_filter &>> cisd
sysctl net.ipv4.conf.default.rp_filter &>> cisd


echo "" >> cisd
echo "" >> cisd

echo "3.5.1 Ensure DCCP is disabled (Not Scored)" >> cisd
echo "install dccp /bin/true" &>> /etc/modprobe.d/CIS.conf 
echo "check output must be install /bin/true" &>> cisd
modprobe -n -v dccp &>> cisd


echo "" >> cisd
echo "" >> cisd

echo "4.1.2 Ensure auditd service is enabled (Scored)" >> cisd
systemctl enable auditd

echo "verify result is "enabled": " >> cisd
systemctl is-enabled auditd &>> cisd

echo "" >> cisd
echo "" >> cisd


echo "4.1.18 Ensure the audit configuration is immutable (Scored)" >> cisd
echo "-e 2" >> /etc/audit/audit.rules 
echo "verify output matches: -e 2" >> cisd
grep "^\s*[^#]" /etc/audit/audit.rules | tail -1 &>> cisd

echo "" >> cisd
echo "" >> cisd


echo "4.2.4 Ensure permissions on all log files are configured (Scored)" >> cisd
find /var/log -type f -exec chmod g-wx,o-rwx {} +
echo "verify that other has no permissions on any files and group does not have write or execute permissions on any files: " >> cisd
find /var/log -type f -ls &>> cisd

echo "" >> cisd
echo "" >> cisd

echo "5.1.3 Ensure permissions on /etc/cron.hourly are configured (Scored)" >> cisd
chown root:root /etc/cron.hourly
chmod og-rwx /etc/cron.hourly
echo "verify Uid and Gid are both 0/root and Access does not grant permissions to group or other: " >> cisd
stat /etc/cron.hourly >> cisd

echo "5.1.4 Ensure permissions on /etc/cron.daily are configured (Scored)" >> cisd
chown root:root /etc/cron.daily
chmod og-rwx /etc/cron.daily
echo "verify Uid and Gid are both 0/root and Access does not grant permissions to group or other:" >> cisd
stat /etc/cron.daily &>> cisd



echo "5.1.5 Ensure permissions on /etc/cron.weekly are configured (Scored)" >> cisd
chown root:root /etc/cron.weekly
chmod og-rwx /etc/cron.weekly
echo "verify Uid and Gid are both 0/root and Access does not grant permissions to group or other:" >> cisd
stat /etc/cron.weekly &>> cisd



echo "5.1.6 Ensure permissions on /etc/cron.monthly are configured (Scored)" >> cisd
chown root:root /etc/cron.monthly 
chmod og-rwx /etc/cron.monthly
echo "verify Uid and Gid are both 0/root and Access does not grant permissions to group or other:  " >> cisd
stat /etc/cron.monthly &>> cisd
 
 
 
echo "5.1.7 Ensure permissions on /etc/cron.d are configured (Scored)" >> cisd
chown root:root /etc/cron.d 
chmod og-rwx /etc/cron.d
echo "verify Uid and Gid are both 0/root and Access does not grant permissions to group or other:" >> cisd
stat /etc/cron.d >> cisd

echo "" >> cisd
echo "" >> cisd

echo "5.2.1 Ensure permissions on /etc/ssh/sshd_config are configured (Scored)" >> cisd
chown root:root /etc/ssh/sshd_config
chmod og-rwx /etc/ssh/sshd_config
echo  "verify Uid and Gid are both 0/root and Access does not grant permissions to group or other: " >> cisd
stat /etc/ssh/sshd_config  >> cisd


echo "" >> cisd
echo "" >> cisd


echo "6.1.3 Ensure permissions on /etc/shadow are configured (Scored)" >> cisd
chown root:root /etc/shadow
chmod 000 /etc/shadow
echo "verify Uid and Gid are 0/root, and Access is 000: " >> cisd
stat /etc/shadow &>> cisd


echo "" >> cisd
echo "" >> cisd


echo "6.1.5 Ensure permissions on /etc/passwd- are configured (Scored)" >> cisd
chown root:root /etc/passwd-
chmod 600 /etc/passwd-
echo "verify Uid and Gid are both 0/root and Access is 600 or more restrictive: " >> cisd
stat /etc/passwd-  &>> cisd
 
echo "" >> cisd
echo "" >> cisd


echo "6.1.6 Ensure permissions on /etc/shadow- are configured (Scored)" >> cisd
chown root:root /etc/shadow- 
chmod 600 /etc/shadow-
echo "verify Uid and Gid are both 0/root and Access is 600 or more restrictive: " >> cisd
stat /etc/shadow-  &>> cisd

echo "" >> cisd
echo "" >> cisd


echo "6.1.7 Ensure permissions on /etc/group- are configured (Scored)" >> cisd
chown root:root /etc/group-  
chmod 600 /etc/group-
echo "verify Uid and Gid are both 0/root and Access is 600 or more restrictive:  " >> cisd
stat /etc/group- &>> cisd







##########################################################################################################
4.1.3 Ensure auditing for processes that start prior to auditd is enabled (Scored)
Audit:
Run the following command and verify that each linux line has the audit=1 parameter set: 
# grep "^\s*linux" /boot/grub2/grub.cfg
***************************************************************
echo 'GRUB_CMDLINE_LINUX="audit=1"' >> /etc/default/grub
grub2-mkconfig > /boot/grub2/grub.cfg
***************************************************************
Remediation:
Edit /etc/default/grub and add audit=1 to GRUB_CMDLINE_LINUX: GRUB_CMDLINE_LINUX="audit=1"
Run the following command to update the grub2 configuration: 
# grub2-mkconfig > /boot/grub2/grub.cfg

4.2.1.3 Ensure rsyslog default file permissions configured (Scored)
Audit:
Run the following command and verify that $FileCreateMode is 0640 or more restrictive: 
# grep ^\$FileCreateMode /etc/rsyslog.conf


Remediation:
Edit the /etc/rsyslog.conf and set $FileCreateMode to 0640 or more restrictive: 
$FileCreateMode 0640



6.1.12 Audit SGID executables (Not Scored)
Audit: 
Run the following command to list SGID files: 
# df --local -P | awk {'if (NR!=1) print $6'} | xargs -I '{}' find '{}' -xdev -type f -perm -2000
 -perm -2000

Remediation: 
Ensure that no rogue SGID programs have been introduced into the system. Review the files returned by the action in the Audit section and confirm the integrity of these binaries.

